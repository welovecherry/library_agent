# TASKS.md


1. ## **1) 프로젝트 개요 및 비전**

- **프로젝트명**: 라이브러리 에이전트
- **한 줄 요약**: 사용자가 입력한 **주소**와 **읽고 싶은 책**을 기반으로, 서울 각 **구별 도서관 사이트**를 자동 탐색해서 “**지금 당장 어디 가면 몇 권을 빌릴 수 있는지**”를 한 번에 추천하는 웹 에이전트.
- **비전**: “검색 노동”을 없애고, **한 번 실행→한 장의 추천 카드**로 끝내는 경험. 나중엔 알림형 에이전트로 확장.

중요. 지금 내가 원하는것: 처음에는 위치 기반으로 구현 안할게. 간단하게 도서관을 'gangnam', 읽고 싶은 책으로 browser use 가 get_library_portal -> search book -> capture_html 순으로 구현 한 후에 다른 노드들을 추가할 계획이야.

---

## **2) 타깃 유저 & 문제 정의**

- **타깃**: 바쁜 서울 시민(직장인/학생/학부모) — 책을 찾느라 **구마다 사이트를 다시 검색**해야 했던 사람들.
- **문제(Pain Points)**
    - 구별 사이트 분절·UI 불균형 → **중복 검색 스트레스**
    - “가능/불가”만 보여줌 → **거리·시간 정보 부재**
    - 실제 생활권(집/회사/학교) 기준의 **가까운 대안 자동 탐색 없음**

---

## **3) 핵심 사용자 경험(UX Flow)**

- **입력(최소 노력)** (나중에 구현할 계획 )
    - **주소**(자유 입력: 도로명/건물명/동까지 OK)
    - **책 제목 1~5권**
    - **교통수단**(도보/자전거/대중교통/자동차 중 택1)
    - **성공 기준**: “요청 N권 중 **최소 M권** 대출 가능 + **이동시간 T분 이하**”
- **처리(에이전트 진행 상황 표시)** (나중에 구현할 계획 )
    - “강남구 탐색 중… → 서초구로 확장… → 송파구로 확장…”
    - 실패/지연 시 자동 **대기→재시도→대안 경로** 진행
- **출력(한 장의 결과 카드)** (나중에 구현할 계획 )
    - **최적 도서관 1곳** + “빌릴 수 있는 책 리스트”
    - **예상 이동시간**(선택한 교통수단 기준)
    - **운영시간/휴관일/주차 여부**(가능한 범위에서 보강 스크랩)
    - **플랜B**: 2~3위 대안(간단 포인트만)

---

## **4) 시스템 아키텍처(Agent 중심)**

- **CLI → (성공 후) Streamlit** 단계적 진행
- **Agent Core: LangGraph**
    - 상태(State)로 address, books[], transport, districts_queue[], results{}, attempts, logs[] 관리
    - 노드: plan_scope → search_district → consolidate → score_select → enrich → finalize
- **웹 에이전트: browser-use**
    - **행동 지시형 프롬프트**로 search / navigate / input / find_text / scroll / extract / write_file / done 사용
    - 실패 복구: wait / refresh / go_back / send_keys
- **지오·경로**
    - 1순위: **카카오/네이버 지도 경로 페이지**에서 시간 추출(간단)
    - 2순위: 가능하면 **API**로 정확도 향상(추후 옵션)
- **데이터 보관**
    - **로컬 JSON**(중간/최종 결과, 캐시 TTL 적용)

---

## **5) 핵심 기능 & 구현 상세**

### **5.1 멀티북·크로스 디스트릭트 검색 에이전트**

- **역할**: 입력한 **여러 권**을, **구별 공식 도서관 사이트**에서 순차 탐색
- **흐름(요지)**
    1. plan_scope: 사용자의 주소를 기준으로 **근접 구 우선 큐** 생성(예: 강남→서초→송파→인접 구)
    2. search_district: browser-use로 해당 구 사이트에서 **각 책**을 검색
    3. N권 중 **M권 이상** 확보되면 다음 단계로, 아니면 **다음 구** 반복
- **기술**: LangGraph + browser-use(search/navigate/input/find_text/extract)

### **5.2 최적 도서관 선정 로직(점수화)**

- **기본 점수식**
    - Score = 2.0 * (대출 가능 권수) – 0.1 * (이동시간 분)
    - 교통수단별 가중치 프로필(초안)
        - 도보/자전거: 시간 패널티 **0.12**
        - 대중교통: **0.10**
        - 자동차: **0.08**
- **선정 기준**
    - 성공 조건(N,M,T) 만족 후보 중 **최고 점수 1곳** → 결과 카드
    - 차순위 2~3곳 → “플랜B”

### **5.3 인간 친화 정보 레이어**

- **추가 수집**: 운영시간, 휴관일, 주차 여부, 연락처(가능 범위)
- **가공 출력**: 표 + 짧은 안내 문장(친절하지만 간결하게)

### **5.4 실패·지연 복구 정책**

- **대기/재시도**
    - 로딩 지연: wait 3s → refresh → wait 10s
    - 여전히 실패: go_back 후 **다른 결과로 navigate**
- **클릭 불가/폼 문제**: send_keys "Tab … Enter"
- **빈 페이지/차단 느낌**: **다른 검색엔진**으로 search → 같은 키워드 재시도
- **CAPTCHA**: 현재는 **스킵** 후 다음 구로

---

## **6) 저장·캐싱 규칙**

- **저장 포맷**: JSON(요청 파라미터, 타임스탬프, 구/도서관/도서별 결과)
- **파일 단위**: run_{datetime}.json / cache_{date}.json
- **캐시 TTL**: 기본 **12시간**(도서관 재고 변동 고려)
- **중복 방지**: 동일(주소 구역+책 리스트) 재요청 시 캐시 우선

---

## **7) LLM/리소스 정책(권장 기본값)**

- **기본 LLM**: **GPT-5**
- **시도 횟수(권장)**
    - **한 페이지 동작 재시도**: 최대 **2회**
    - **한 구에서의 검색 재시도**(다른 경로/결과): 최대 **2회**
    - **전체 구 수 한도**: 기본 **5개 구**(근접 우선)
- **탭 개수 제한**: 동시 **최대 4탭**(메모리/안정성)
- **타임아웃**: 페이지 로딩 **20초**, 전체 태스크 **3~5분** 목표
- 이 값들은 나중에 **환경변수/설정 파일**로 쉽게 조정하게 하자.

## **현재 구조 (LangGraph 기반 설계)**

### **1️⃣**

### **resolve_catalog**

- 입력: place (예: “songpa”, “gangnam”, “seocho”)
- 역할: 도서관별 홈페이지 URL 조회
- 출력: catalog_home_url

👉 이 단계는 성공적으로 작동 중.

00_src/graph/pipeline_graph.py 에서 LangGraph로 관리.

---

## 🧩 작업명: search_book → capture_html 연결

### 🎯 목표
도서관 웹사이트에서 도서 검색 후, 결과 페이지 HTML을 캡처하고 저장한다.

### 📥 입력
- `place`: 구 이름 (예: gangnam, seocho)
- `title`: 책 제목 (예: 숨결이 바람될 때)
- `catalog_home_url`: 도서관 메인 URL

### 📤 출력
- `ok`: bool
- `result_hint`: str (“results_detected”, “no_results”, “timeout”)
- `saved_html_path`: str

### ⚙️ 단계
1. LangGraph에서 `search_book` → `capture_html` 노드 순으로 연결
2. `search_book`이 성공(`ok=True`)이면, 해당 브라우저 세션 그대로 `capture_html`로 전달
3. `capture_html`은 페이지의 DOM 전체를 저장 (iframe 포함)
4. 저장 위치: `00_src/data/raw/{today}/{place}_{timestamp}_results.html`

### 🧠 추가 메모
- DOM 신호 기반 대기
- 텔레메트리 비활성 유지
- headless=False 유지